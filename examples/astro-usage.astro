---
/**
 * Example Astro page showing how to use the food loader
 *
 * This demonstrates the hybrid approach where:
 * 1. Individual food files are maintained in data/foods/
 * 2. Build script aggregates them into dist/foods-bundle.json
 * 3. This page loads the bundle at build time for SSG
 */

import { loadFoodBundle, getAllCategories } from '../src/utils/food-loader';

// Load food data at build time (SSG)
const foodData = await loadFoodBundle();
const foods = foodData.foods;
const categories = foodData.categories || await getAllCategories();

// Calculate some statistics
const totalFoods = foods.length;
const avgPropertiesPerFood = foods.reduce((sum, f) => sum + f.properties.length, 0) / totalFoods;
const foodsWithSynergies = foods.filter(f => f.synergies.length > 0).length;

// Group foods by category
const foodsByCategory = new Map<string, typeof foods>();
for (const category of categories) {
  foodsByCategory.set(
    category,
    foods.filter(f => f.categories.includes(category))
  );
}

// Find most cited pages
const pageCounts = new Map<number, number>();
foods.forEach(food => {
  food.sources.pages.forEach(page => {
    pageCounts.set(page, (pageCounts.get(page) || 0) + 1);
  });
});
const topPages = Array.from(pageCounts.entries())
  .sort((a, b) => b[1] - a[1])
  .slice(0, 5);
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>How Not to Diet - Food Database</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem;
        line-height: 1.6;
        color: #333;
      }

      h1 {
        color: #2d5016;
        border-bottom: 3px solid #4a7c2c;
        padding-bottom: 0.5rem;
      }

      h2 {
        color: #4a7c2c;
        margin-top: 2rem;
      }

      .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin: 2rem 0;
      }

      .stat-card {
        background: #f5f5f5;
        padding: 1.5rem;
        border-radius: 8px;
        border-left: 4px solid #4a7c2c;
      }

      .stat-value {
        font-size: 2rem;
        font-weight: bold;
        color: #2d5016;
      }

      .stat-label {
        color: #666;
        font-size: 0.9rem;
      }

      .food-card {
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        transition: transform 0.2s, box-shadow 0.2s;
      }

      .food-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      }

      .food-name {
        font-size: 1.5rem;
        font-weight: bold;
        color: #2d5016;
        margin-bottom: 0.5rem;
      }

      .food-id {
        color: #999;
        font-size: 0.85rem;
        font-family: monospace;
      }

      .categories {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin: 0.5rem 0;
      }

      .category-badge {
        background: #e8f5e9;
        color: #2d5016;
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.85rem;
        border: 1px solid #c8e6c9;
      }

      .benefits {
        color: #555;
        margin: 1rem 0;
        font-style: italic;
      }

      .properties {
        list-style: none;
        padding-left: 0;
      }

      .properties li:before {
        content: "âœ“ ";
        color: #4a7c2c;
        font-weight: bold;
      }

      .synergies {
        margin-top: 1rem;
        padding: 1rem;
        background: #f9fdf9;
        border-left: 3px solid #4a7c2c;
      }

      .category-section {
        margin-bottom: 3rem;
      }

      .page-ref {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.25rem 0.75rem;
        background: #e3f2fd;
        border-radius: 4px;
        font-size: 0.9rem;
        margin-right: 0.5rem;
        margin-bottom: 0.5rem;
      }

      .page-number {
        font-weight: bold;
        color: #1976d2;
      }

      .citation-count {
        color: #666;
        font-size: 0.85rem;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin: 1rem 0;
      }

      th, td {
        padding: 0.75rem;
        text-align: left;
        border-bottom: 1px solid #ddd;
      }

      th {
        background: #f5f5f5;
        font-weight: 600;
      }
    </style>
  </head>
  <body>
    <h1>How Not to Diet - Food Database</h1>

    <p>
      Extraction date: {foodData.extraction_metadata.extraction_date}
      {foodData.build_metadata && (
        <><br />Build timestamp: {new Date(foodData.build_metadata.build_timestamp).toLocaleString()}</>
      )}
    </p>

    <div class="stats">
      <div class="stat-card">
        <div class="stat-value">{totalFoods}</div>
        <div class="stat-label">Total Foods</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">{categories.length}</div>
        <div class="stat-label">Categories</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">{avgPropertiesPerFood.toFixed(1)}</div>
        <div class="stat-label">Avg Properties/Food</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">{foodsWithSynergies}</div>
        <div class="stat-label">Foods with Synergies</div>
      </div>
    </div>

    <h2>Most Referenced Pages</h2>
    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
      {topPages.map(([page, count]) => (
        <div class="page-ref">
          <span class="page-number">p.{page}</span>
          <span class="citation-count">({count} foods)</span>
        </div>
      ))}
    </div>

    <h2>Focus Areas</h2>
    <ul>
      {foodData.extraction_metadata.focus_areas.map(area => (
        <li>{area}</li>
      ))}
    </ul>

    <h2>Foods by Category</h2>

    {categories.map(category => {
      const categoryFoods = foodsByCategory.get(category) || [];
      if (categoryFoods.length === 0) return null;

      return (
        <div class="category-section">
          <h3>{category.replace(/-/g, ' ').toUpperCase()} ({categoryFoods.length})</h3>

          {categoryFoods.map(food => (
            <div class="food-card">
              <div>
                <span class="food-name">{food.name}</span>
                <span class="food-id">{food.id}</span>
              </div>

              <div class="categories">
                {food.categories.map(cat => (
                  <span class="category-badge">{cat}</span>
                ))}
              </div>

              <div class="benefits">{food.benefits}</div>

              <ul class="properties">
                {food.properties.slice(0, 3).map(prop => (
                  <li>{prop}</li>
                ))}
                {food.properties.length > 3 && (
                  <li>...and {food.properties.length - 3} more</li>
                )}
              </ul>

              <div>
                <strong>Amount:</strong> {food.amount}<br />
                <strong>Timing:</strong> {food.timing.join(', ')}
              </div>

              {food.synergies.length > 0 && (
                <div class="synergies">
                  <strong>Synergies:</strong> {food.synergies.join(', ')}
                </div>
              )}

              <div style="margin-top: 1rem; font-size: 0.9rem; color: #666;">
                <strong>Sources:</strong> Pages {food.sources.pages.join(', ')}
              </div>
            </div>
          ))}
        </div>
      );
    })}

    <h2>All Foods (Alphabetical)</h2>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Categories</th>
          <th>Amount</th>
          <th>Pages</th>
        </tr>
      </thead>
      <tbody>
        {foods
          .slice()
          .sort((a, b) => a.name.localeCompare(b.name))
          .map(food => (
            <tr>
              <td><strong>{food.name}</strong></td>
              <td>{food.categories.length}</td>
              <td>{food.amount}</td>
              <td>{food.sources.pages.join(', ')}</td>
            </tr>
          ))
        }
      </tbody>
    </table>
  </body>
</html>
