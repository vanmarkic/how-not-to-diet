---
import Layout from '@layouts/Layout.astro';
import fs from 'fs';
import path from 'path';

// Load all foods from the foods bundle
const dataPath = path.join(process.cwd(), 'public', 'foods-bundle.json');
const foodsData = JSON.parse(fs.readFileSync(dataPath, 'utf-8'));
const foods = foodsData.foods;
const categories = foodsData.categories;
const totalFoods = foodsData.build_metadata.total_foods;

const structuredData = {
  "@context": "https://schema.org",
  "@type": "ItemList",
  "name": "Healthy Foods Database",
  "description": "Comprehensive database of foods with health benefits, synergies, and nutrition timing",
  "numberOfItems": totalFoods,
  "itemListElement": foods.slice(0, 20).map((food: any, index: number) => ({
    "@type": "ListItem",
    "position": index + 1,
    "item": {
      "@type": "Thing",
      "name": food.name,
      "description": Array.isArray(food.benefits) ? food.benefits.join(', ') : food.benefits
    }
  }))
};
---

<Layout 
  title={`${totalFoods} Healthy Foods Database - How Not To Diet`}
  description={`Explore ${totalFoods} scientifically-backed foods with health benefits, synergies, optimal timing, and recommended amounts. Based on How Not To Diet research.`}
  keywords="healthy foods database, food synergies, anti-inflammatory foods, plant-based nutrition, daily dozen, food timing, nutrition science, healthy eating guide"
  structuredData={structuredData}
>
  <div class="foods-page">
    <header class="page-header">
      <h1>Food Synergies Database</h1>
      <p>Explore {totalFoods} foods with relationships, timing, and amounts from "How Not to Diet"</p>
    </header>

    <div class="controls">
      <div class="search-bar">
        <input
          type="text"
          id="search-input"
          placeholder="Search foods by name, benefits, or properties..."
          aria-label="Search foods"
        />
      </div>

      <div class="filters">
        <label for="category-filter">Filter by category:</label>
        <select id="category-filter" aria-label="Filter by category">
          <option value="">All Categories ({totalFoods} foods)</option>
          {categories.sort().map((cat: string) => (
            <option value={cat}>{cat.replace(/-/g, ' ')}</option>
          ))}
        </select>
        <button id="clear-filters" class="clear-btn" type="button">Clear Filters</button>
      </div>

      <div class="stats">
        <span id="visible-count">{totalFoods}</span> of {totalFoods} foods shown
      </div>
    </div>

    <div class="foods-grid" id="foods-grid">
      {foods.map((food: any) => (
        <a
          href={`/how-not-to-diet/foods/${food.id}`}
          class="food-card"
          id={`food-${food.id}`}
          data-name={food.name.toLowerCase()}
          data-benefits={Array.isArray(food.benefits) ? food.benefits.join(' ').toLowerCase() : (food.benefits || '').toLowerCase()}
          data-properties={Array.isArray(food.properties) ? food.properties.join(' ').toLowerCase() : ''}
          data-categories={Array.isArray(food.categories) ? food.categories.join(' ') : ''}
          data-timing={Array.isArray(food.timing) ? food.timing.join(' ') : ''}
        >
          <div class="food-header">
            <h3>{food.name}</h3>
            <div class="categories">
              {Array.isArray(food.categories) && food.categories.map((cat: string) => (
                <span class="category-badge">{cat.replace(/-/g, ' ')}</span>
              ))}
            </div>
          </div>

          <div class="food-body">
            <div class="section">
              <h4>Benefits</h4>
              {Array.isArray(food.benefits) ? (
                <ul>
                  {food.benefits.map((benefit: string) => (
                    <li>{benefit}</li>
                  ))}
                </ul>
              ) : (
                <p>{food.benefits}</p>
              )}
            </div>

            {Array.isArray(food.properties) && food.properties.length > 0 && (
              <div class="section">
                <h4>Properties</h4>
                <ul>
                  {food.properties.map((prop: string) => (
                    <li>{prop}</li>
                  ))}
                </ul>
              </div>
            )}

            {Array.isArray(food.synergies) && food.synergies.length > 0 && (
              <div class="section synergies">
                <h4>Works Well With</h4>
                <div class="synergy-tags">
                  {food.synergies.map((synergy: string) => (
                    <span class="synergy-tag">{synergy}</span>
                  ))}
                </div>
              </div>
            )}

            {Array.isArray(food.conflicts) && food.conflicts.length > 0 && (
              <div class="section conflicts">
                <h4>Avoid Combining With</h4>
                <div class="conflict-tags">
                  {food.conflicts.map((conflict: string) => (
                    <span class="conflict-tag">{conflict}</span>
                  ))}
                </div>
              </div>
            )}

            {Array.isArray(food.timing) && food.timing.length > 0 && (
              <div class="section timing">
                <h4>Best Timing</h4>
                <div class="timing-tags">
                  {food.timing.map((time: string) => (
                    <span class="timing-tag">{time}</span>
                  ))}
                </div>
              </div>
            )}

            {food.amount && (
              <div class="section amount">
                <h4>Recommended Amount</h4>
                <p class="amount-text">{food.amount}</p>
              </div>
            )}

            {food.sources && (
              <div class="section sources">
                <h4>Sources</h4>
                {Array.isArray(food.sources.pages) && food.sources.pages.length > 0 && (
                  <p class="pages">Pages: {food.sources.pages.join(', ')}</p>
                )}
                {Array.isArray(food.sources.quotes) && food.sources.quotes.map((quote: string) => (
                  <blockquote>{quote}</blockquote>
                ))}
              </div>
            )}
          </div>
        </a>
      ))}
    </div>
  </div>
</Layout>

<script>
  // Search and filter functionality
  const searchInput = document.getElementById('search-input') as HTMLInputElement;
  const categoryFilter = document.getElementById('category-filter') as HTMLSelectElement;
  const clearFiltersBtn = document.getElementById('clear-filters') as HTMLButtonElement;
  const foodsGrid = document.getElementById('foods-grid') as HTMLElement;
  const visibleCount = document.getElementById('visible-count') as HTMLElement;

  // Get URL parameters
  const urlParams = new URLSearchParams(window.location.search);
  const urlCategory = urlParams.get('category');
  const urlTiming = urlParams.get('timing');
  const urlSearch = urlParams.get('search');

  // Apply URL parameters on page load
  if (urlCategory) {
    categoryFilter.value = urlCategory;
  }
  if (urlSearch) {
    searchInput.value = urlSearch;
  }

  // Store timing filter (not in UI dropdown, but from URL)
  let timingFilter = urlTiming || '';

  // Show active filters banner if URL params exist
  if (urlCategory || urlTiming || urlSearch) {
    showActiveFiltersBanner();
  }

  function showActiveFiltersBanner() {
    const controls = document.querySelector('.controls') as HTMLElement;
    const existingBanner = document.getElementById('active-filters-banner');
    if (existingBanner) existingBanner.remove();

    const banner = document.createElement('div');
    banner.id = 'active-filters-banner';
    banner.className = 'active-filters-banner';

    let filterText = 'Active filters: ';
    const filters = [];

    if (urlSearch) filters.push(`Search: "${urlSearch}"`);
    if (urlCategory) filters.push(`Category: ${urlCategory.replace(/-/g, ' ')}`);
    if (urlTiming) filters.push(`Timing: ${urlTiming}`);

    filterText += filters.join(', ');

    banner.innerHTML = `
      <span>${filterText}</span>
      <button onclick="clearAllFilters()" class="clear-all-btn">Clear All ✕</button>
    `;

    controls.insertAdjacentElement('afterend', banner);
  }

  function filterFoods() {
    const searchTerm = searchInput.value.toLowerCase();
    const selectedCategory = categoryFilter.value;
    const foodCards = foodsGrid.querySelectorAll('.food-card');
    let visibleCards = 0;

    foodCards.forEach((card) => {
      const htmlCard = card as HTMLElement;
      const name = htmlCard.dataset.name || '';
      const benefits = htmlCard.dataset.benefits || '';
      const properties = htmlCard.dataset.properties || '';
      const categories = htmlCard.dataset.categories || '';
      const timing = htmlCard.dataset.timing || '';

      // Check if matches search term
      const matchesSearch = !searchTerm ||
        name.includes(searchTerm) ||
        benefits.includes(searchTerm) ||
        properties.includes(searchTerm);

      // Check if matches category filter
      const matchesCategory = !selectedCategory ||
        categories.includes(selectedCategory);

      // Check if matches timing filter
      const matchesTiming = !timingFilter ||
        timing.includes(timingFilter);

      // Show or hide the card
      if (matchesSearch && matchesCategory && matchesTiming) {
        htmlCard.style.display = '';
        visibleCards++;
      } else {
        htmlCard.style.display = 'none';
      }
    });

    visibleCount.textContent = visibleCards.toString();
  }

  function clearFilters() {
    searchInput.value = '';
    categoryFilter.value = '';
    timingFilter = '';

    // Remove URL parameters
    const url = new URL(window.location.href);
    url.search = '';
    window.history.replaceState({}, '', url.toString());

    // Remove banner
    const banner = document.getElementById('active-filters-banner');
    if (banner) banner.remove();

    filterFoods();
  }

  // Make clearAllFilters global for banner button
  (window as any).clearAllFilters = clearFilters;

  // Add event listeners
  searchInput.addEventListener('input', filterFoods);
  categoryFilter.addEventListener('change', filterFoods);
  clearFiltersBtn.addEventListener('click', clearFilters);

  // Add keyboard shortcut for search (Ctrl/Cmd + K)
  document.addEventListener('keydown', (e) => {
    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
      e.preventDefault();
      searchInput.focus();
    }
  });

  // Apply initial filters from URL
  filterFoods();
</script>

<style>
  .foods-page {
    max-width: 1400px;
    margin: 0 auto;
  }

  .page-header {
    text-align: center;
    margin-bottom: 3rem;
    padding-bottom: 2rem;
    border-bottom: 2px solid var(--color-border);
  }

  h1 {
    font-size: 2.5rem;
    color: var(--color-primary);
    margin-bottom: 0.5rem;
  }

  .page-header p {
    font-size: 1.125rem;
    color: var(--color-secondary);
  }

  .controls {
    background: white;
    padding: 1.5rem;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    margin-bottom: 2rem;
    display: grid;
    gap: 1rem;
    grid-template-columns: 1fr auto;
    align-items: center;
  }

  .search-bar {
    grid-column: 1 / -1;
  }

  .search-bar input {
    width: 100%;
    padding: 0.75rem 1rem;
    border: 2px solid #e0e0e0;
    border-radius: 6px;
    font-size: 1rem;
    transition: border-color 0.2s;
  }

  .search-bar input:focus {
    outline: none;
    border-color: var(--color-accent);
  }

  .filters {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .filters label {
    font-weight: 600;
    color: var(--color-secondary);
    white-space: nowrap;
  }

  .filters select {
    padding: 0.5rem 1rem;
    border: 2px solid #e0e0e0;
    border-radius: 6px;
    font-size: 0.95rem;
    background: white;
    cursor: pointer;
    transition: border-color 0.2s;
  }

  .filters select:focus {
    outline: none;
    border-color: var(--color-accent);
  }

  .clear-btn {
    padding: 0.5rem 1.25rem;
    background: var(--color-accent);
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 0.95rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
  }

  .clear-btn:hover {
    background: #e53935;
    transform: translateY(-1px);
  }

  .clear-btn:active {
    transform: translateY(0);
  }

  .stats {
    text-align: right;
    font-size: 0.95rem;
    color: var(--color-secondary);
    white-space: nowrap;
  }

  .stats #visible-count {
    font-weight: 700;
    color: var(--color-accent);
    font-size: 1.1rem;
  }

  .active-filters-banner {
    background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
    border: 2px solid #ff9800;
    border-radius: 8px;
    padding: 1rem 1.5rem;
    margin-bottom: 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 8px rgba(255, 152, 0, 0.2);
  }

  .active-filters-banner span {
    font-size: 1rem;
    color: #e65100;
    font-weight: 500;
  }

  .clear-all-btn {
    background: #ff5722;
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }

  .clear-all-btn:hover {
    background: #d84315;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(255, 87, 34, 0.3);
  }

  .foods-grid {
    display: grid;
    gap: 2rem;
    grid-template-columns: repeat(auto-fill, minmax(500px, 1fr));
  }

  .food-card {
    background: white;
    border-radius: 8px;
    padding: 2rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    transition: transform 0.2s, box-shadow 0.2s;
    text-decoration: none;
    color: inherit;
    display: block;
    cursor: pointer;
  }

  .food-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
  }

  .food-card:hover .food-header {
    background: linear-gradient(135deg, #388e3c 0%, #43a047 100%);
  }

  .food-card:hover h3 {
    transform: scale(1.02);
  }

  .food-header {
    margin-bottom: 1.5rem;
    padding: 1.5rem;
    background: linear-gradient(135deg, #2e7d32 0%, #388e3c 100%);
    border-radius: 8px 8px 0 0;
    margin: -2rem -2rem 1.5rem -2rem;
    transition: all 0.3s ease;
  }

  .food-header h3 {
    font-size: 1.75rem;
    color: #ffffff;
    margin-bottom: 0.75rem;
    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    transition: transform 0.3s ease;
  }

  .categories {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .category-badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    background: rgba(255, 255, 255, 0.25);
    color: #ffffff;
    border-radius: 12px;
    font-size: 0.85rem;
    font-weight: 600;
    border: 1px solid rgba(255, 255, 255, 0.3);
  }

  .section {
    margin-bottom: 1.5rem;
  }

  .section h4 {
    color: var(--color-secondary);
    font-size: 1rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 0.75rem;
  }

  .section p {
    line-height: 1.6;
    color: var(--color-text);
  }

  .section ul {
    list-style: none;
    padding: 0;
  }

  .section ul li {
    padding: 0.5rem 0;
    padding-left: 1.5rem;
    position: relative;
    line-height: 1.6;
  }

  .section ul li::before {
    content: "✓";
    position: absolute;
    left: 0;
    color: var(--color-accent);
    font-weight: bold;
  }

  .synergy-tags,
  .conflict-tags,
  .timing-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .synergy-tag {
    padding: 0.5rem 1rem;
    background: #e8f5e9;
    color: #2e7d32;
    border-radius: 4px;
    font-size: 0.9rem;
    font-weight: 500;
  }

  .conflict-tag {
    padding: 0.5rem 1rem;
    background: #ffebee;
    color: #c62828;
    border-radius: 4px;
    font-size: 0.9rem;
    font-weight: 500;
  }

  .timing-tag {
    padding: 0.5rem 1rem;
    background: #e3f2fd;
    color: #1565c0;
    border-radius: 4px;
    font-size: 0.9rem;
    font-weight: 500;
  }

  .amount-text {
    font-weight: 600;
    color: var(--color-primary);
    font-size: 1.05rem;
  }

  .sources {
    background: #f9f9f9;
    padding: 1rem;
    border-radius: 4px;
  }

  .pages {
    font-size: 0.9rem;
    color: #666;
    font-style: italic;
    margin-bottom: 0.75rem;
  }

  blockquote {
    margin: 0.75rem 0;
    padding-left: 1rem;
    border-left: 3px solid var(--color-accent);
    font-style: italic;
    color: #555;
    line-height: 1.6;
  }

  @media (max-width: 1024px) {
    .foods-grid {
      grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
    }
  }

  @media (max-width: 768px) {
    .foods-grid {
      grid-template-columns: 1fr;
    }

    .controls {
      grid-template-columns: 1fr;
    }

    .filters {
      flex-direction: column;
      align-items: stretch;
    }

    .filters label {
      font-size: 0.9rem;
    }

    .stats {
      text-align: left;
    }

    .active-filters-banner {
      flex-direction: column;
      gap: 1rem;
      align-items: stretch;
    }

    .active-filters-banner span {
      font-size: 0.9rem;
    }

    .clear-all-btn {
      width: 100%;
    }

    h1 {
      font-size: 2rem;
    }

    .food-card {
      padding: 1.5rem;
    }

    .food-header {
      margin: -1.5rem -1.5rem 1.5rem -1.5rem;
      padding: 1.25rem;
    }

    .food-header h3 {
      font-size: 1.5rem;
    }
  }

  @media (max-width: 480px) {
    .foods-page {
      padding: 0 1rem;
    }

    h1 {
      font-size: 1.75rem;
    }

    .page-header p {
      font-size: 1rem;
    }

    .controls {
      padding: 1rem;
    }

    .food-card {
      padding: 1rem;
    }
  }
</style>
