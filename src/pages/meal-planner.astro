---
import Layout from '@layouts/Layout.astro';
import SynergyScore from '@components/SynergyScore.astro';
import { loadRecipes, loadFoods } from '@utils/dataLoader';
import { analyzeDaySynergies, analyzeMealSynergies } from '@utils/synergyEngine';

const recipes = await loadRecipes();
const foods = await loadFoods();

// Example day with both sample recipes
const breakfast = recipes.find(r => r.category === 'breakfast');
const lunch = recipes.find(r => r.category === 'lunch');

let dayAnalysis = null;
let breakfastAnalysis = null;
let lunchAnalysis = null;

if (breakfast && lunch) {
  dayAnalysis = await analyzeDaySynergies(breakfast, lunch);
  breakfastAnalysis = await analyzeMealSynergies(breakfast);
  lunchAnalysis = await analyzeMealSynergies(lunch);
}
---

<Layout title="Weekly Menu Planner - Food Synergies">
  <main>
    <div class="container">
      <h1>Weekly Menu Planner with Food Synergies</h1>

      <section class="intro">
        <p>
          Plan your weekly meals based on food synergies from "The How Not to Diet Cookbook".
          This system analyzes combinations of foods for optimal health benefits, timing, and
          nutritional balance based on Dr. Greger's Daily Dozen and 21 Tweaks.
        </p>
      </section>

      {dayAnalysis && (
        <section class="analysis-section">
          <h2>Today's Menu Analysis</h2>
          <SynergyScore score={dayAnalysis.totalScore} maxScore={150} />

          <div class="foods-included">
            <h3>Foods Included Today</h3>
            <div class="food-tags">
              {dayAnalysis.foodsIncluded.map(food => (
                <span class="food-tag">{food}</span>
              ))}
            </div>
          </div>

          {dayAnalysis.synergyPairs.length > 0 && (
            <div class="synergy-pairs">
              <h3>Food Synergies Detected</h3>
              {dayAnalysis.synergyPairs.slice(0, 5).map(pair => (
                <div class="synergy-pair">
                  <div class="pair-header">
                    <strong>{pair.food1}</strong> + <strong>{pair.food2}</strong>
                    <span class="pair-score">+{pair.score}</span>
                  </div>
                  <ul class="pair-reasons">
                    {pair.reasons.map(reason => (
                      <li>{reason}</li>
                    ))}
                  </ul>
                </div>
              ))}
            </div>
          )}

          <div class="category-balance">
            <h3>Category Balance</h3>
            <div class="categories-grid">
              {Object.entries(dayAnalysis.categoryBalance).map(([category, count]) => (
                <div class="category-item">
                  <span class="category-name">{category.replace(/-/g, ' ')}</span>
                  <span class="category-count">{count}</span>
                </div>
              ))}
            </div>
          </div>

          {dayAnalysis.recommendations.length > 0 && (
            <div class="recommendations">
              <h3>Recommendations</h3>
              <ul>
                {dayAnalysis.recommendations.map(rec => (
                  <li>{rec}</li>
                ))}
              </ul>
            </div>
          )}
        </section>
      )}

      <section class="meals-section">
        <h2>Meal Details</h2>

        {breakfast && breakfastAnalysis && (
          <div class="meal-card">
            <h3>{breakfast.name}</h3>
            <p class="meal-time">Breakfast</p>
            <p>{breakfast.description}</p>
            <SynergyScore score={breakfastAnalysis.totalScore} maxScore={50} />
            <div class="meal-foods">
              <strong>Power foods:</strong>
              {breakfastAnalysis.foodsIncluded.map((food, idx) => (
                <span>
                  {food}{idx < breakfastAnalysis.foodsIncluded.length - 1 ? ', ' : ''}
                </span>
              ))}
            </div>
          </div>
        )}

        {lunch && lunchAnalysis && (
          <div class="meal-card">
            <h3>{lunch.name}</h3>
            <p class="meal-time">Lunch</p>
            <p>{lunch.description}</p>
            <SynergyScore score={lunchAnalysis.totalScore} maxScore={50} />
            <div class="meal-foods">
              <strong>Power foods:</strong>
              {lunchAnalysis.foodsIncluded.map((food, idx) => (
                <span>
                  {food}{idx < lunchAnalysis.foodsIncluded.length - 1 ? ', ' : ''}
                </span>
              ))}
            </div>
          </div>
        )}
      </section>

      <section class="food-database">
        <h2>Food Database ({foods.length} foods)</h2>
        <p class="food-db-description">
          These foods have been extracted from "The How Not to Diet Cookbook" with their
          properties, synergies, and optimal timing.
        </p>
        <div class="foods-grid">
          {foods.map(food => (
            <div class="food-card">
              <h4>{food.name}</h4>
              <div class="food-categories">
                {food.categories.slice(0, 3).map(cat => (
                  <span class="category-badge">{cat.replace(/-/g, ' ')}</span>
                ))}
              </div>
              <p class="food-amount">{food.amount}</p>
              {food.synergies.length > 0 && (
                <div class="food-synergies">
                  <strong>Synergizes with:</strong> {food.synergies.slice(0, 3).join(', ')}
                </div>
              )}
            </div>
          ))}
        </div>
      </section>
    </div>
  </main>
</Layout>

<style>
  .container {
    max-width: var(--max-width);
    margin: 0 auto;
    animation: fadeIn var(--transition-slow);
  }

  h1 {
    font-size: clamp(2.25rem, 6vw, 3.5rem);
    color: var(--color-primary);
    margin-bottom: var(--spacing-md);
    animation: slideUp 0.5s ease-out;
  }

  @keyframes slideUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  h2 {
    font-size: clamp(1.75rem, 4vw, 2.25rem);
    color: var(--color-primary);
    margin-top: var(--spacing-xl);
    margin-bottom: var(--spacing-md);
    position: relative;
    padding-bottom: 0.5rem;
  }

  h2::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    width: 60px;
    height: 3px;
    background: linear-gradient(90deg, var(--color-carrot) 0%, transparent 100%);
    border-radius: var(--radius-full);
  }

  .intro {
    background: linear-gradient(135deg, rgba(91, 140, 90, 0.08) 0%, rgba(230, 126, 34, 0.05) 100%);
    padding: var(--spacing-lg);
    border-radius: var(--radius-md);
    border-left: 4px solid var(--color-kale);
    margin-bottom: var(--spacing-xl);
    position: relative;
    overflow: hidden;
    animation: slideUp 0.5s ease-out 0.1s backwards;
  }

  .intro::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -10%;
    width: 300px;
    height: 300px;
    background: radial-gradient(circle, rgba(230, 126, 34, 0.08) 0%, transparent 70%);
    border-radius: 47% 53% 58% 42% / 43% 39% 61% 57%;
  }

  .intro p {
    margin: 0;
    color: var(--color-charcoal);
    line-height: 1.8;
    font-size: 1.05rem;
    position: relative;
  }

  .analysis-section {
    background: var(--color-bg-elevated);
    padding: var(--spacing-lg);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-md);
    margin-bottom: var(--spacing-xl);
    position: relative;
    overflow: hidden;
    animation: slideUp 0.5s ease-out 0.2s backwards;
  }

  .analysis-section::before {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    width: 200px;
    height: 200px;
    background: radial-gradient(circle, rgba(91, 140, 90, 0.05) 0%, transparent 70%);
    border-radius: 50%;
    transform: translate(30%, -30%);
  }

  .foods-included {
    margin-top: var(--spacing-lg);
  }

  .foods-included h3 {
    color: var(--color-primary);
    margin-bottom: var(--spacing-sm);
    font-size: 1.25rem;
  }

  .food-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.625rem;
    margin-top: var(--spacing-sm);
  }

  .food-tag {
    background: linear-gradient(135deg, var(--color-kale) 0%, var(--color-forest-mid) 100%);
    color: var(--color-cream);
    padding: 0.5rem 1rem;
    border-radius: var(--radius-full);
    font-size: 0.9rem;
    font-weight: 600;
    box-shadow: var(--shadow-sm);
    transition: all var(--transition-base);
    cursor: default;
  }

  .food-tag:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
  }

  .synergy-pairs {
    margin-top: var(--spacing-lg);
  }

  .synergy-pairs h3 {
    color: var(--color-primary);
    margin-bottom: var(--spacing-md);
    font-size: 1.25rem;
  }

  .synergy-pair {
    background: linear-gradient(135deg, rgba(230, 126, 34, 0.03) 0%, rgba(91, 140, 90, 0.03) 100%);
    padding: var(--spacing-md);
    border-radius: var(--radius-md);
    margin-bottom: var(--spacing-sm);
    border-left: 4px solid var(--color-carrot);
    transition: all var(--transition-base);
    position: relative;
    overflow: hidden;
  }

  .synergy-pair::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent 0%, rgba(230, 126, 34, 0.05) 50%, transparent 100%);
    transition: left var(--transition-slow);
  }

  .synergy-pair:hover::before {
    left: 100%;
  }

  .synergy-pair:hover {
    transform: translateX(4px);
    box-shadow: var(--shadow-sm);
  }

  .pair-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--spacing-sm);
    gap: var(--spacing-sm);
    flex-wrap: wrap;
  }

  .pair-score {
    background: linear-gradient(135deg, var(--color-carrot) 0%, #d97921 100%);
    color: white;
    padding: 0.375rem 0.875rem;
    border-radius: var(--radius-full);
    font-size: 0.9rem;
    font-weight: 700;
    box-shadow: var(--shadow-sm);
    white-space: nowrap;
  }

  .pair-reasons {
    margin: 0;
    padding-left: 1.5rem;
    color: var(--color-slate);
  }

  .pair-reasons li {
    margin-bottom: 0.375rem;
    font-size: 0.925rem;
    line-height: 1.6;
  }

  .category-balance {
    margin-top: var(--spacing-lg);
  }

  .category-balance h3 {
    color: var(--color-primary);
    margin-bottom: var(--spacing-md);
    font-size: 1.25rem;
  }

  .categories-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(min(220px, 100%), 1fr));
    gap: var(--spacing-sm);
    margin-top: var(--spacing-sm);
  }

  .category-item {
    background: linear-gradient(135deg, var(--color-sand) 0%, var(--color-stone) 100%);
    padding: var(--spacing-sm);
    border-radius: var(--radius-sm);
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: all var(--transition-base);
    gap: var(--spacing-xs);
  }

  .category-item:hover {
    transform: scale(1.02);
    box-shadow: var(--shadow-sm);
  }

  .category-name {
    font-size: 0.9rem;
    color: var(--color-charcoal);
    text-transform: capitalize;
    font-weight: 500;
  }

  .category-count {
    background: linear-gradient(135deg, var(--color-forest-deep) 0%, var(--color-forest-mid) 100%);
    color: var(--color-cream);
    padding: 0.25rem 0.625rem;
    border-radius: var(--radius-full);
    font-size: 0.875rem;
    font-weight: 700;
    min-width: 28px;
    text-align: center;
  }

  .recommendations {
    margin-top: var(--spacing-lg);
    background: linear-gradient(135deg, rgba(230, 126, 34, 0.08) 0%, rgba(212, 165, 116, 0.08) 100%);
    padding: var(--spacing-lg);
    border-radius: var(--radius-md);
    border-left: 4px solid var(--color-carrot);
    position: relative;
  }

  .recommendations h3 {
    margin-top: 0;
    color: var(--color-beet);
    font-size: 1.25rem;
  }

  .recommendations ul {
    margin: var(--spacing-sm) 0 0;
    padding-left: 1.5rem;
    color: var(--color-charcoal);
  }

  .recommendations li {
    margin-bottom: 0.625rem;
    line-height: 1.7;
  }

  .meals-section {
    margin-top: var(--spacing-xl);
  }

  .meal-card {
    background: var(--color-bg-elevated);
    padding: var(--spacing-lg);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-sm);
    margin-bottom: var(--spacing-md);
    position: relative;
    overflow: hidden;
    transition: all var(--transition-base);
  }

  .meal-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 4px;
    height: 100%;
    background: linear-gradient(180deg, var(--color-kale) 0%, var(--color-carrot) 100%);
  }

  .meal-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-md);
  }

  .meal-card h3 {
    margin-top: 0;
    color: var(--color-primary);
    font-size: 1.5rem;
  }

  .meal-time {
    color: var(--color-slate);
    font-size: 0.85rem;
    margin-top: -0.5rem;
    margin-bottom: var(--spacing-sm);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    font-weight: 600;
  }

  .meal-foods {
    margin-top: var(--spacing-md);
    color: var(--color-charcoal);
    font-size: 0.95rem;
    line-height: 1.7;
  }

  .meal-foods strong {
    color: var(--color-primary);
  }

  .food-database {
    margin-top: var(--spacing-xl);
    padding-top: var(--spacing-xl);
    border-top: 2px solid var(--color-stone);
  }

  .food-db-description {
    color: var(--color-slate);
    margin-bottom: var(--spacing-lg);
    font-size: 1.05rem;
    line-height: 1.7;
  }

  .foods-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(min(300px, 100%), 1fr));
    gap: var(--spacing-md);
  }

  .food-card {
    background: var(--color-bg-elevated);
    padding: var(--spacing-md);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-sm);
    transition: all var(--transition-base);
    position: relative;
    overflow: hidden;
  }

  .food-card::before {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    width: 60px;
    height: 60px;
    background: linear-gradient(135deg, transparent 0%, rgba(91, 140, 90, 0.05) 100%);
    border-radius: 0 var(--radius-md) 0 100%;
  }

  .food-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-md);
  }

  .food-card h4 {
    margin-top: 0;
    color: var(--color-primary);
    font-size: 1.25rem;
    margin-bottom: var(--spacing-sm);
  }

  .food-categories {
    display: flex;
    flex-wrap: wrap;
    gap: 0.375rem;
    margin-bottom: var(--spacing-sm);
  }

  .category-badge {
    background: linear-gradient(135deg, rgba(91, 140, 90, 0.12) 0%, rgba(91, 140, 90, 0.08) 100%);
    color: var(--color-forest-mid);
    padding: 0.25rem 0.625rem;
    border-radius: var(--radius-sm);
    font-size: 0.75rem;
    text-transform: capitalize;
    font-weight: 600;
    border: 1px solid rgba(91, 140, 90, 0.15);
  }

  .food-amount {
    color: var(--color-kale);
    font-weight: 700;
    font-size: 0.9rem;
    margin: var(--spacing-xs) 0;
  }

  .food-synergies {
    color: var(--color-slate);
    font-size: 0.9rem;
    margin-top: var(--spacing-sm);
    line-height: 1.6;
  }

  .food-synergies strong {
    color: var(--color-charcoal);
    font-weight: 600;
  }

  /* Enhanced Mobile Responsiveness */
  @media (max-width: 768px) {
    h1 {
      font-size: 2rem;
    }

    .intro,
    .analysis-section,
    .meal-card,
    .recommendations {
      padding: var(--spacing-md);
    }

    .categories-grid {
      grid-template-columns: 1fr;
    }

    .foods-grid {
      grid-template-columns: 1fr;
    }

    .pair-header {
      flex-direction: column;
      align-items: flex-start;
    }

    .pair-score {
      align-self: flex-end;
    }
  }

  @media (max-width: 480px) {
    .food-tags {
      gap: 0.5rem;
    }

    .food-tag {
      font-size: 0.85rem;
      padding: 0.375rem 0.75rem;
    }

    .category-item {
      padding: 0.625rem;
    }
  }

  /* Accessibility: Reduced motion */
  @media (prefers-reduced-motion: reduce) {
    *,
    *::before,
    *::after {
      animation-duration: 0.01ms !important;
      animation-iteration-count: 1 !important;
      transition-duration: 0.01ms !important;
    }
  }
</style>
